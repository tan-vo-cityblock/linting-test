version: 2

sources:

  - name: karuna
    description: Set of data dumps from karuna
    database: cityblock-analytics
    schema: src_karuna
    loaded_at_field: dataLoadedAt
    freshness: {}  # do not check freshness for this table

    tables:
      - name: phone_call_karuna
        columns:
          - name: id
          - name: externalCallId
            description: Call ID generated by Karuna
          - name: userId
          - name: patientId
            description: CBH patientId attached to calls by Karuna
          - name: contactNumber
          - name: contactPhoneType
          - name: direction
            tests:
              - not_null
          - name: type
          - name: durationSeconds
            tests:
              - not_null
          - name: callSubject
          - name: callNote
          - name: isDuringBusinessHours
            description: Indicates whether a call was made or attempted during business hours, meaning between 9am and 5pm
            tests:
              - not_null
          - name: isTransferredFromTalkdesk
            description: Indicates whether an incoming call was transferred from TalkDesk, which likely means it was transferred from the virtual hub to the field team
            tests:
              - dbt_utils.not_null_where:
                  where: "direction = 'incoming'"
          - name: isTransferredToAnsweringService
            description: Indicates whether an incoming call was transferred to a service where people answer the call and take a message
            tests:
              - dbt_utils.not_null_where:
                  where: "direction = 'incoming'"
          - name: isTransferredToVoicemail
            description: Indicates whether an incoming call was transferred to voicemail
            tests:
              - dbt_utils.not_null_where:
                  where: "direction = 'incoming'"
          - name: isAbandoned
            tests:
              - not_null
          - name: isRecorded
            tests:
              - not_null
          - name: hasMatchingTalkdeskCall
            description: Indicates whether there is an inbound Talkdesk call from that phone number starting after the Karuna createdAt timestamp and ending within 1 minute of the Karuna endedAt timestamp
            tests:
              - dbt_utils.not_null_where:
                  where: "direction = 'incoming'"
          - name: isInitiallyToFieldTeam
            description: Indicates whether call was originally directed at field team
          - name: providerCreatedAt
            description: Timestamp in UTC at which call was made
            tests:
              - not_null
          - name: dataLoadedAt
            description: Manually added timestamp in UTC with an estimate when Karuna sent the data dump, used to compute freshness
            tests:
              - not_null

      - name: text_message_karuna
        columns:
          - name: id
            tests:
              - not_null
              - unique
          - name: externalMessageId
            description: Message ID generated by Karuna
            tests:
              - not_null
              - unique
          - name: userId
          - name: patientId
            description: CBH patientId attached to sms message data by Karuna
          - name: contactNumber
            tests:
              - not_null
          - name: contactPhoneType
          - name: direction
            tests:
              - not_null
          - name: body
          - name: type
          - name: isDuringBusinessHours
            description: Indicates whether an sms message was sent during business hours, meaning between 9am and 5pm
            tests:
              - not_null
          - name: providerCreatedAt
            description: Timestamp in UTC at which message was sent
            tests:
              - not_null
          - name: dataLoadedAt
            description: Manually added timestamp in UTC with an estimate of when Karuna sent the data dump, used to compute freshness
            tests:
              - not_null
