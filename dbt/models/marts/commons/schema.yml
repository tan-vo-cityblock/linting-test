version: 2

models:
  - name: derived_additional_states
    description: "Author: Dax, Adds hard_to_reach and other additional states. "
  
  - name: goal_task_collaborators
    description: Table containing all users collaborating on a task, either by creating or completing the task, or by having the task assigned to them.
    columns:
      - name: goalGroupId
        description: The ID of the goal
      - name: taskGroupId
        description: The ID of the task
      - name: userId

  - name: member
    description: "-- Author: Tommy Wu \n
          -- Purpose      Primary starting point for all member level queries \n
          -- Notes        Name, current_state, cohort, pod needed for all members. Gated to include real cohorts only. \n
          -- Dependencies commons_mirror.[patient,market,clinic,partner] \n
          --              mrt_commons.primary_chp_pod, mrt_commons.member_states \n
          --              member_index.cohort, member_index.member \n
          -- Links        https://docs.google.com/spreadsheets/d/1oAz93YeqXMXAPse8U8Q8eSYy4ZIwR_MncnYSoduwLqA/edit#gid=737008703 \n
          "
    columns:
        - name: patientId
          description: "Primary identifier for patient"
          tests:
              - unique
              - not_null
        - name: primaryContactUserName
          description: Full name of primary contact on member's Cityblock care team
        - name: primaryContactUserEmail
          description: Email address of primary contact on member's Cityblock care team
        - name: memberPod
          description: Name of member pod, inherited from user designated as primary contact
        - name: isSuperUtilizer
          description: Indicator based on super-utilizer computed field
        - name: topPathwaySlug
          description: Top-ranked pathway to which member has been algorithmically assigned, according to partner hierarchy
        - name: topPathwayProjectedSavingsPerMonth
          description: Projected monthly savings based on member's top algorithmically assigned pathway
        - name: recommendedMemberAcuityScore
          description: Current recommended acuity score
        - name: recommendedMemberAcuityDescription
          description: Current recommended acuity description
        - name: isComprehensiveMedicationManagementCandidate
          description: Indicates whether member may benefit from comprehensive medication management
          accepted_values:
            values: [true, false]
            quote: false
        - name: comprehensiveMedicationManagementRiskFactorCount
          description: Number of risk factors indicating that member may benefit from comprehensive medication management
          accepted_values:
            values: [0,1,2,3,4,5]
            quote: false

  - name: member_appointment_statuses
    description: "\n
    Author- Tommy Wu\n
    Purpose- Appointment table from Commons with some quality of life derived fields added for easier interpretability. \n
    The raw commons_mirror.appointments table combines Commons, EPIC (NYC ACPNY only), and Elation (CCI Cityblock only) appointments. \n
    Updated 2021 to include additional appointment-status level fields from Elation and Epic, creating intentional fanout to one row per appointment status, rather than one row per appointment. \n
    Dependencies- commons_mirror.appointment, elation_mirror.appointment_latest, elation_mirror.appointment_status_latest, streaming.redox_messages, commons.patient_siu_event"  

  - name: member_care_team_all
    description: "\n
    Author- Marianne Hoogeveen\n
    Purpose- Lists all users that have at any time been part of a member's care team."
    columns:
      - name: patientId
        tests:
          - not_null
      - name: userId
        tests:
          - not_null
      - name: careTeamMemberAssignedAt
        tests:
          - not_null
      - name: careTeamMemberAssignedUntil
      - name: userRole
      - name: userName
      - name: userEmail
      - name: podName
      - name: isPrimaryContact

    
  - name: member_commons_completion
    description: "
    - Author: Katie Claiborne\n
    - Purpose: Timestamps and flags for completion of various Commons milestones (initial assessment, generated care plan, etc)\n
    "
    columns:
      - name: patientId
        tests:
          - not_null
          - unique

      - name: hasHealthcareProxy
        description: Flag derived from boolean field in patient_info

      - name: hasMolst
        description: "\n
        - MOLST = medical orders for life-sustaining treatment\n
        - Flag derived from boolean field in patient_info\n
        "

      - name: hasAdvanceDirectives
        description: Flag derived based on presence of healthcare proxy or MOLST

      - name: minAcpDocumentUploadAt
        description: "\n
        - ACP = advance care planning\n
        - Earliest upload of documentType 'hcp' or 'molst'
        "

      - name: minDemographicsAt
        description: Earliest timestamp based on boolean field in computed_patient_status

      - name: hasAssessment
        description: Flag identifying members with any non-deleted risk area assessment submission

      - name: hasAnyAnswers
        description: Flag identifying members with any non-deleted answer
        
      - name: minTaskAt
        description: Earliest creation of a task associated with a goal

      - name: hasGeneratedCarePlan
        description: Flag identifying members with at least one task associated with a goal
        
      - name: minCompletedTaskAt
        description: Earliest completion of a task associated with a goal

      - name: hasCompletedOneTask
        description: Flag identifying members with at least one completed task associated with a goal

      - name: acuityAssignedAt
        description: Earliest creation of non-recommended acuity

      - name: minCaseConferenceAt
        description: Earliest timeline event of type 'caseConference'

      - name: maxCaseConferenceAt
        description: Latest timeline event of type 'caseConference'

      - name: daysSinceLastCaseConference
        description: Date difference between current timestamp and latest case conference

      - name: totalNumCaseConferenceEver
        description: Number of timeline events of type 'caseConference'

      - name: verifiedMedListAt
        description: Earliest evidence of assessment answer and post-consent medication reconciliation by a Cityblock provider

      - name: hasHadAppointmentThisYear
        description: Flag identifying members whose most recently passed appointment start time falls in the current year

      - name: minComprehensiveAssessmentAt
        description: Earliest screening tool submission for slug 'baseline-nyc-ct' (NY/CT) or 'comprehensive' (MA)

      - name: maxComprehensiveAssessmentAt
        description: Latest screening tool submission for slug 'baseline-nyc-ct' (NY/CT) or 'comprehensive' (MA)

      - name: minMdsAssessmentAt
        description: "\n
        - MDS = minimum data set\n
        - Specific to Tufts\n
        - Earliest screening tool submission for slug 'mds'\n
        "

      - name: maxMdsAssessmentAt
        description: "\n
        - MDS = minimum data set\n
        - Specific to Tufts\n
        - Latest screening tool submission for slug 'mds'\n
        "

      - name: bothTuftsContractualAssessmentsAt
        description: Earliest of the latest timestamp of screening tool submission for slugs 'comprehensive' and 'mds'

      - name: earliestMdsInterviewCompletedAt
        description: Time of earliest member answer to questionSlug 'ready-for-review'

      - name: latestMdsInterviewCompletedAt
        description: Time of latest member answer to questionSlug 'ready-for-review'

      - name: minInitialAssessmentAt
        description: Earliest time of comprehensive assessment and demographics completion

      - name: earliestHraCompletedAt
        description: earliest screening tool submission for HRA  to question slug 'assessment-reference-date-time'

      - name: latestHraCompletedAt
        description: latest screening tool submission for HRA  to question slug 'assessment-reference-date-time'

  - name: member_commons_completion_date_delta
    description: "\n
    Author- Tommy Wu (Katie Claiborne)\n
    Purpose- Timedeltas from our various commons_completion related dates to the cohortGoLive and consentedAt dates \n
    "

  - name: member_current_acuity
    description: "Author- Tommy Wu Purpose- Pulls current acuity score from commons mirror and maps it to a description value"

  - name: member_current_care_team_all
    description: "\n
    Author- \n
    Purpose- Lists all users currently in a member's care team."
    columns:
      - name: patientId
        tests:
          - not_null
      - name: userId
        tests:
          - not_null
      - name: careTeamMemberAssignedAt
        tests:
          - not_null
      - name: userRole
      - name: userName
      - name: userEmail
      - name: podName
      - name: isPrimaryContact

  - name: member_current_domain_acuity
    description: Lists current member acuity scores by domain
    tests:
      - unique:
          column_name: "concat(patientId, domainName)"
      - dbt_utils.expression_is_true:
          expression: "acuityScore >= 0 and acuityScore <=5"
          severity: warn
    columns:
      - name: patientId
      - name: domainName
        description: Short title of Commons risk area group
        tests:
          - not_null:
              severity: warn
      - name: acuityScore
        description: Integer value ranging from zero to five, with higher values indicating greater acuity
        tests:
          - not_null
      - name: acuityDescription
        description: Acuity level, ranging from 'No Acuity' for a score of zero to 'Critical' for a score of five
        tests:
          - not_null:
              severity: warn

  - name: member_external_care_team
    description: "\n
    Author    Katie Claiborne\n
    Purpose   Identify members' current external providers and their organizations\n
    "
    tests:
      - unique:
          column_name: "concat(patientId, patientExternalProviderId)"

    columns:
      - name: patientId
      - name: patientExternalProviderId
      - name: providerName
        tests:
          - not_null
      - name: providerRole
        tests:
          - not_null
      - name: organizationName
        tests:
          - not_null

  - name: member_goals_tasks_all
    description: Contains all non-administrative goals and tasks, including those that have been deleted
    columns:
      - name: id
        description: Unique identifier, based on combination of `goalId` and `taskGroupId`
        tests:
          - unique
          - not_null
      - name: patientId
      - name: goalId
        description: The ID of the goal.
      - name: goalTitle
      - name: goalLabel
      - name: goalCreatedAt
      - name: goalUpdatedAt
      - name: goalCompletedAt
      - name: goalDeletedAt
        description: Time at which goal was deleted
      - name: isDeletedGoal
        description: Indicates whether goal has been deleted
      - name: archivedAt
        description: Time at which goal was archived
      - name: isArchivedGoal
        description: Indicates whether goal has been archived
      - name: goalDueAt
        description: Date on which the goal is due.
      - name: taskGroupId
        description: The ID of the task.
      - name: taskId
        description: The ID of the current task state.
      - name: taskTitle
      - name: taskCreatedById
      - name: taskAssignedToId
      - name: taskCompletedById
      - name: taskCreatedAt
      - name: taskUpdatedAt
      - name: taskCompletedAt
      - name: taskDeletedAt
        description: Time at which task was deleted
      - name: isDeletedTask
        description: Indicates whether task has been deleted
      - name: isVisibleTaskInCommonsInbox
        description: Commons inbox automatically filters out a few categories of tasks, this indicates them
      - name: taskDueAt
        description: Date on which the task is due.
      - name: isMemberSelfManagement
      - name: goalIsLegacy
      - name: taskIsLegacy
      - name: taskIsDraft
      - name: isUrgentTask
      - name: taskStatus
      - name: taskDescription
      - name: taskLabels
      - name: taskIsAssociatedWithGoal
      - name: taskIsCompleted
      - name: taskBatchUploadId
        description: >
          Identifier corresponding to bulk task upload.
          Will be null if task was not created in a bulk upload.
      - name: goalIsCompleted
      - name: numGoalCollaborators
      - name: numTaskCollaborators
      - name: isOverdueTask
        description: the task is overdue when taskisCompleted = false and taskDueAt is before currentdate

  - name: member_goals_tasks
    description: Limited version of `member_goals_tasks_all`, containing only undeleted goals and tasks
    tests:
      - dbt_utils.expression_is_true:
          expression: "goalDeletedAt is null and taskDeletedAt is null"

  - name: member_historical_delivery_model
    description: "\n
    Author:  Andrew Seiden
    Purpose: Track historic careDeliveryModel at the member-month level, based on the 1st of the month; and create a 2-mo lagged riskDeliveryModel for actuarial/financial analytics \n
    "
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - patientId
            - calendarMonth

  - name: member_historical_pod
    description: "\n
    Author   Katie Claiborne\n
    Purpose  Track member pod, inherited from primary CHP, over time\n
    "
    tests:
      - unique:
          column_name: "concat(patientId, calendarDate)"

    columns:
      - name: calendarDate
      - name: patientId
      - name: userId
      - name: userRole
      - name: clinicPodId
        tests: 
          - not_null
      - name: podName
      - name: clinicName
      - name: marketName

  - name: member_historical_states
    description: " \n
    Author- Tommy Wu \n
    Purpose- Track member historical status over time\n"


  - name: member_historical_acuity
    description: " \n
    Author- Tommy Wu \n
    Purpose- Grabs our latest acuity per member per day using EST midnight as the cutoff. This includes deletedAt prior acuities for historical tracking. \n
    Dependencies- commons_mirror.patient_acuity\n"

  - name: member_info
    description: " \n
    -- Author       Tommy Wu (Marianne Hoogeveen) \n
    -- Purpose      Demographic, address, and other administrative member level info \n
    -- Notes        Carved out from derived_member_summary in Looker \n
    --              We may want to split this out further if some columns are largely unused \n
    -- Dependencies commons_mirror.[patient,patient_info,address,phone,patient_document,patient_answer,answer,question] \n
                    member_index_mirror.[email, phone] \n
    -- Links        https://docs.google.com/spreadsheets/d/1oAz93YeqXMXAPse8U8Q8eSYy4ZIwR_MncnYSoduwLqA/edit#gid=737008703 \n
    "
    columns:
      - name: patientId
        tests:
          - unique
      - name: age
      - name: dateOfBirth
      - name: zipcode
      - name: phone1
      - name: phone2
      - name: phone3
      - name: phone4
      - name: phone5
      - name: phoneType1
      - name: phoneType2
      - name: phoneType3
      - name: phoneType4
      - name: phoneType5      
      - name: needToKnow
      - name: gender
      - name: transgender
      - name: maritalStatus
      - name: language
      - name: raceEthnicity
      - name: employment
      - name: education
      - name: housing
      - name: canReceiveCalls
      - name: hasEmail
      - name: email1
      - name: email2
      - name: memberId
      - name: medicaidId
      - name: nmi
      - name: lat
      - name: long
      - name: street1
      - name: street2
      - name: zip
      - name: state
      - name: city
      - name: addressDescription
      - name: hasTextConsent
      - name: textConsentType
        tests:
          - accepted_values:
              values: ['email', 'verbal', 'written']
      - name: textConsentedAt
      - name: hasEmailConsent
      - name: emailConsentType
        tests:
          - accepted_values:
              values: [ 'written', 'verbal' ]
      - name: emailConsentedAt
      - name: acuityRank

  - name: member_initial_acuity
    description: " \n
    Author- Tommy Wu \n
    Purpose- Grabs our initial acuity for a given member as well as flags whether the acuity has ever changed. \n
    Dependencies- member_historical_acuity\n"

  - name: member_interactions_all
    description: Expanded model classifying Commons outreach and progress notes, along with Epic and Elation notes

  - name: member_interactions
    description: "{{ doc('member_interactions') }}"
    tests:
      - maximum_accepted_values:
          column_to_count: groupedEventType
          max_values: 30
          severity: warn
    columns:
      - name: eventSource
        tests:
          - accepted_values:
              values: ['commons_progress_notes', 'elation_notes', 'epic_notes']
      - name: patientId
      - name: userId
      - name: progressNoteId
        tests:
          - unique
      - name: progressNoteGroupId
      - name: eventType
      - name: groupedEventType
        description: >
          Resolves slight differences in `eventType` values across sources, based on mappings in `dta_medical_mapped_note_types`.
          For example, `eventType` values of `phone` and `phoneCall` both appear with a `groupedEventType` value of `Phone Call`.
      - name: location
      - name: legacyTitle
      - name: legacyLocation
      - name: status
      - name: isTransitionOfCare
      - name: direction
      - name: isReferral
      - name: Referral
      - name: referralReasons
      - name: eventTimestamp
      - name: progressNoteFirstCompletedAt
      - name: memberInteractionKey
      - name: isLegacy
      - name: isAttemptedTend
      - name: isSuccessfulTend
      - name: isAttemptedConnection
      - name: isSuccessfulConnection
      - name: isAttemptedInPersonVisit
      - name: isSuccessfulInPersonVisit
      - name: isAttemptedTocConnection
      - name: isSuccessfulTocConnection
      - name: isAttemptedTocInPersonVisit
      - name: isSuccessfulTocInPersonVisit
      - name: isAssociatedWithClinicalIntake
        tests:
          - not_null
      - name: clinicalIntakeId
      - name: hasMemberAttendee
      - name: hasParentOrGuardianAttendee
      - name: hasHealthFacilityAttendee
      - name: hasHealthCareProxyAttendee
      - name: hasShortTermSurrogateAttendee
      - name: progressNoteText

  - name: member_location
    description: " \n
    Author- Tommy Wu \n
    Purpose- Experimental table for joining on census blocks from public data to our geocoordinates using std_within(\n 
    Dependencies- mrt_commons.member_info,bigquery-public-data.geo_census_tracts.* \n"


  - name: latest_member_interactions
    description: " \n
    Author- Tommy Wu \n
    Purpose- View on top of member_interactions purely to grab the latest type of member interaction for each member as 1 row.
    We also grab the userName associated with the particular interaction. This feeds a surprisingly large amount of our business questions from the hubs.\n 

    Dependencies- mrt_commons.member_interactions, mrt_commons.user\n"

  - name: member_phone_numbers
    description: "\n
    - Author   Katie Claiborne
    - Purpose  Lists member phone numbers and types, with flags for primary numbers and members with multiple numbers.\n
    "
    tests:
      - unique:
          column_name: "concat(patientId, phoneNumber)"

    columns:
      - name: patientId
      - name: hasMultipleNumbers
      - name: phoneNumber
      - name: phoneType
      - name: isPrimaryPhone

  - name: member_primary_care_team
    description: Identifies care team member most recently assigned to member by role

    columns:
      - name: patientId
        tests: 
          - not_null
          - unique

  - name: member_primary_os
    description: " \n
      -- Purpose      Coerces a member to OS relationship to the latest OS to \n
      -- Dependencies mrt_commons.user, commons_mirror.care_team"

  - name: member_state_delta_days
    description: "\n
    -- Author       Tommy Wu \n
    -- Purpose      Day timedeltas for each member state in Commons \n
    -- Notes        Both in between states and days from state to current date \n
    -- Dependencies mrt_commons.member_states \n"

  - name: member_states
    description: Pulls member current state and earliest timestamp for all other states

    columns:
      - name: patientId
        tests:
          - not_null
          - unique
      - name: isReattributed
        description: This flag indicates if a member was ever disenrolled and then enrolled with CBH.
        tests:
          - not_null
      - name: latestContactAttemptedAt
        description: Gives the latest contact attempted timestamp, since `contactAttempted` gives the earliest. This helps with, for example, re-enrolled members.

      - name: latestDisenrollmentReason
        description: Reason associated with member's latest accepted disenrollment

  - name: questions_answers_all
    description: "Author- Jordan Ryda  \n
                  Purpose- Past and current answers and associated questions from screening tools and assessments \n
                  Omits deleted questions and answers. \n
                  Handles freetext autosaves and picks final single-select historical answers. \n 
                  Option to reduce noise across submissions within a single day by picking the final answer
    "
    columns:
      - name: issubmitted
        description: indicator of the answer's submission status
        tests:
          - not_null
      - name: isLatestPatientAnswer
        description: indicator of the patient's latest non-deleted submission and completed (non-deleted) answer
        tests:
          - not_null

  - name: questions_answers_current
    description: " \n
    Author- Tommy Wu\n
    Purpose- Current, non-deleted answers only. \n
    "   
  
  - name: sms_session
    description: ""

  - name: telecom
    description: ""
  
  - name: user
    description: "
    -------------------------------------------------------------------------------\n
    -- Author       Tommy Wu\n
    -- Purpose      Simple joins to pull in the market, clinic, pod for users\n
    -- Notes        Excludes non-clinical users, aka back-office-admins at the Block\n
    --              Excludes user who have not yet logged into Commons\n
    -- Links        https://docs.google.com/spreadsheets/d/1oAz93YeqXMXAPse8U8Q8eSYy4ZIwR_MncnYSoduwLqA/edit#gid=762538695\n
    -------------------------------------------------------------------------------\n
    "
    columns:
      - name: userId
        tests:
          - not_null
          - unique
      - name: userName
        description: Full name of the user
        tests:
          - not_null
      - name: userRole
        tests:
          - not_null
      - name: userEmail
        tests:
          - not_null
      - name: userPhone
      - name: userNpi
      - name: podName
      - name: userHomeClinicName
        tests:
          - not_null
      - name: userHomeMarketName
        tests:
          - not_null
      - name: userCreationDate
        tests:
          - not_null
      - name: userTerminationDate

  - name: timeline_event
    description: "\n
    - Author   Katie Claiborne \n
    - Purpose  Filter for non-deleted, published timeline events not marked as errors and extract metadata elements. \n
    "
    columns:
      - name: isTransitionOfCare
        description: Indicates whether user applied "Transition of Care" label to note
      - name: direction
        description: Indicates whether note describes an inbound or outbound interaction
      - name: isReferral
        description: Indicates whether user applied "Referral" label to note
      - name: Referral
        description: Indicates who/where the referral was made to
      - name: referralReason
        description: Indicates the reason why a referral was made

  - name: user_historical
    description: "
    -------------------------------------------------------------------------------\n
    -- Author       Tommy Wu\n
    -- Purpose      Simple joins to pull in the market, clinic, pod for the historical version of the user table\n
    -- Notes        Excludes non-clinical users, aka back-office-admins at the Block\n
    --              Excludes user who have not yet logged into Commons\n
    -------------------------------------------------------------------------------\n
    "
  - name: user_historical_panel_size
    description: " \n
    Author- Dax Paramanathan \n
    Purpose- Track daily panel size (count of distinct patients) for all Commons users over time, with correponding patientIds in array\n"
